{% extends 'base.html' %}
	{% load staticfiles %}
    {% block content %}
    <br>
    <br>
    <div class="container" style="margin-top:50px;">
    <br>
      <div class="row">
        <div class="col-md-3">
          <!-- <div class="form-group form-inline">
              <label>Search Product : &emsp;</label>
              <input type="text" name="search" id="search" class="form-control"/>
          </div> -->
          <!-- <div class="text-center">
            <button class="btn btn-lg btn-primary" id="search_btn" ><span class="glyphicon glyphicon-search"></span>Search</button>
          </div> -->
          <br>
          <div class="panel panel-default sidebar-menu">
            <div class="panel-heading">
              <h3 class="panel-title">Categories</h3>
            </div>
            <div class="panel-body">
              <ul class="nav nav-pills nav-stacked" id="category_section"></ul>
            </div>
          </div>  
        </div>        
        <div class="col-md-9" id="products">
          <table id="search_results" class="table table-striped table-bordered text-center vcenter table-responsive">
            <thead>
              <tr>
                <td class="info"> Product Name</td>
                <td class="info"> Category </td>
                <td class="info">  Weight </td>
                <td class="info"> MRP<span> &#x20B9;</span>  </td>
                <td class="info">Selling Price </td>
                <td class="info"> GST(%) </td>
              </tr>
            </thead>
            <tbody id="tbd">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script type="text/javascript"> 
        $(document).ready(function() {
          $('#search_results').DataTable();
          $.ajax(
                        {
                            type: 'get',
                            url: "{{client_service_url}}"+"products_categories/",
                            headers: {'X-Authorization-Token' : "{{request.session.userservice_key}}",
                                  'content_type':'application/json'},
                            dataType: 'json',
                            success : function(data)
                                    {
                                        result = data['responseData'];
                                        console.log(result);
                                        populate_category(result);
                                    },
                                    error : function(error)
                                    {
                                        window.alert(error);
                                    },
                        });

          function populate_category(result){
              for(i=0;i<result.length;i++){
                    if(result[i]['product_count'] > 0){
                        var span = document.createElement("span");
                        span.innerHTML = "&emsp;";
                        var li_element = document.createElement('li');
                        var checkbox_text = document.createTextNode(result[i]['name'] + " (" + result[i]['product_count'] + ")");
                        var checkbox = document.createElement("INPUT");
                        checkbox.setAttribute("type", "checkbox");
                        checkbox.setAttribute('id',result[i]['id'])
                        checkbox.setAttribute('value',result[i]['name']);
                        li_element.append(checkbox);
                        li_element.append(span);
                        li_element.appendChild(checkbox_text);
                        $("#category_section").append(li_element);

                        checkbox.onclick = function(){
                            category_id = this.id;
                            if ($(this).prop('checked')==true){ 
                              $.ajax(
                                          {
                                              type: 'get',
                                              url: "{{client_service_url}}"+"product_by_categories/?category_id="+category_id,
                                              headers: {'X-Authorization-Token' : "{{request.session.userservice_key}}",
                                            'content_type':'application/json'},
                                              dataType: 'json',
                                              success : function(result)
                                                      {
                                                          console.log(result);
                                                          populate_table(result['responseData']);
                                                      },
                                                      error : function(error)
                                                      {
                                                          window.alert(error);
                                                      },
                                          });
                          }
                          else{
                            $("#tbd").empty();
                          }
                        }
                    }
                }
            }

            function populate_table(result){
                $.each(result, function(i, field){
                    $('#search_results').dataTable().fnAddData( [
                                  field['name'],
                                  field['category'],
                                  field['weight'],
                                  field['mrp'],
                                  field['sellingPrice'],
                                  field['gst']
                                   ] );
                });
              }
        });
    </script>
{% endblock %}